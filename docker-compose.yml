version: "3.8"

services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-tlx_ads}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-tlx_ads}"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  # DEV ONLY: expõe Postgres na máquina host sem abrir porta no serviço real
  # Uso: docker-compose --profile dev up
  postgres-port:
    image: alpine/socat:1.8.0.0
    profiles: ["dev"]
    command: ["-d", "-d", "TCP-LISTEN:5432,fork,reuseaddr", "TCP:postgres:5432"]
    ports:
      - "5432:5432"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  redis:
    image: redis:7
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  # DEV ONLY: expõe Redis na máquina host
  redis-port:
    image: alpine/socat:1.8.0.0
    profiles: ["dev"]
    command: ["-d", "-d", "TCP-LISTEN:6379,fork,reuseaddr", "TCP:redis:6379"]
    ports:
      - "6379:6379"
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  otel-collector:
    image: otel/opentelemetry-collector:0.103.0
    command: ["--config=/etc/otelcol/config.yaml"]
    volumes:
      - ./otel/otel-collector-config.yaml:/etc/otelcol/config.yaml:ro
    restart: unless-stopped

  # DEV ONLY: expõe OTLP HTTP no host (útil pra testes locais)
  otel-port:
    image: alpine/socat:1.8.0.0
    profiles: ["dev"]
    command: ["-d", "-d", "TCP-LISTEN:4318,fork,reuseaddr", "TCP:otel-collector:4318"]
    ports:
      - "4318:4318"
    depends_on:
      otel-collector:
        condition: service_started
    restart: unless-stopped

  api:
    build:
      context: ./tlx-ads/backend
    environment:
      # DB sqlite persistido em volume
      TLX_ADS_DB_PATH: "/data/data.sqlite3"

      # (upgrade futuro) Postgres URL, ainda não usado pelo backend atual
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/tlx_ads}

      JWT_SECRET: ${JWT_SECRET:-CHANGE_ME_SUPER_SECRET}
      PWD_SALT: ${PWD_SALT:-CHANGE_ME_PEPPER}
      JWT_EXPIRES_MIN: ${JWT_EXPIRES_MIN:-240}

      # Rate limit redis (multi-instância)
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      RATE_LIMIT_PER_MIN: ${RATE_LIMIT_PER_MIN:-120}

      # Domínios (troque pro oficial depois, sem dor)
      PUBLIC_WEB_BASE: ${PUBLIC_WEB_BASE:-http://localhost:5173}
      PUBLIC_API_BASE: ${PUBLIC_API_BASE:-http://localhost:8000}

      # Pixel allowlist
      PIXEL_ALLOWED_ORIGINS: ${PIXEL_ALLOWED_ORIGINS:-http://localhost:5173}

      # OTel export (OTLP/HTTP)
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4318/v1/traces}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-tlxauto-ads}

      # DEV: retornar tokens/links nas respostas
      DEV_RETURN_TOKEN_LINKS: ${DEV_RETURN_TOKEN_LINKS:-1}

      # admin job
      ADMIN_KEY: ${ADMIN_KEY:-CHANGE_ME_ADMIN_KEY}

      # automação
      AUTOMATION_MAX_BATCH: ${AUTOMATION_MAX_BATCH:-500}

      # Stripe (assinaturas em USD)
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_PRICE_FREE: ${STRIPE_PRICE_FREE:-}
      STRIPE_PRICE_PRO: ${STRIPE_PRICE_PRO:-}
      STRIPE_PRICE_BUSINESS: ${STRIPE_PRICE_BUSINESS:-}
      STRIPE_SUCCESS_URL: ${STRIPE_SUCCESS_URL:-http://localhost:5173/planos?success=1}
      STRIPE_CANCEL_URL: ${STRIPE_CANCEL_URL:-http://localhost:5173/planos?canceled=1}
      STRIPE_BILLING_PORTAL_RETURN_URL: ${STRIPE_BILLING_PORTAL_RETURN_URL:-http://localhost:5173/planos}

    ports:
      - "8000:8000"
    volumes:
      - tlxadsdata:/data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/health >/dev/null || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 30
    restart: unless-stopped
    stop_grace_period: 20s

  worker:
    build:
      context: ./tlx-ads/backend
    command: ["python", "/app/jobs/worker_loop.py"]
    environment:
      TLX_ADS_DB_PATH: "/data/data.sqlite3"
      ADMIN_KEY: ${ADMIN_KEY:-CHANGE_ME_ADMIN_KEY}
    volumes:
      - tlxadsdata:/data
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    stop_grace_period: 20s

  web:
    build:
      context: ./tlx-ads/frontend
    environment:
      PUBLIC_API_BASE: ${PUBLIC_API_BASE:-http://localhost:8000}
      PUBLIC_WEB_BASE: ${PUBLIC_WEB_BASE:-http://localhost:5173}
    ports:
      - "5173:5173"
    depends_on:
      api:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:5173/').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 30
    restart: unless-stopped
    stop_grace_period: 10s

  edge:
    image: caddy:2-alpine
    profiles: ["edge"]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      api:
        condition: service_started
      web:
        condition: service_started
    restart: unless-stopped

volumes:
  tlxadsdata:
  pgdata:
  caddy_data:
  caddy_config:
